<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChimeraOrchestrator Test</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #000;
      color: #0f0;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: #0f0;
      border-bottom: 2px solid #0f0;
      padding-bottom: 10px;
    }
    
    .section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #0f0;
      background: #001100;
    }
    
    .section h2 {
      margin-top: 0;
      color: #0ff;
    }
    
    button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-weight: bold;
    }
    
    button:hover {
      background: #0ff;
    }
    
    button:disabled {
      background: #555;
      color: #888;
      cursor: not-allowed;
    }
    
    #output {
      background: #000;
      border: 1px solid #0f0;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-wrap;
    }
    
    .status {
      display: inline-block;
      padding: 2px 8px;
      margin: 0 5px;
      border-radius: 3px;
    }
    
    .status.online {
      background: #0f0;
      color: #000;
    }
    
    .status.offline {
      background: #f00;
      color: #fff;
    }
    
    .status.mock {
      background: #ff0;
      color: #000;
    }
    
    .info {
      color: #0ff;
    }
    
    .success {
      color: #0f0;
    }
    
    .error {
      color: #f00;
    }
    
    .warning {
      color: #ff0;
    }
  </style>
</head>
<body>
  <h1>ChimeraOrchestrator Test Interface</h1>
  
  <div class="section">
    <h2>Initialization</h2>
    <button id="initBtn">Initialize Orchestrator</button>
    <button id="checkHealthBtn" disabled>Check Health</button>
    <div id="initStatus"></div>
  </div>
  
  <div class="section">
    <h2>Service Status</h2>
    <div id="serviceStatus">
      <p>Blockchain: <span class="status offline">Offline</span></p>
      <p>Quantum: <span class="status offline">Offline</span></p>
      <p>Bio Sensor: <span class="status offline">Offline</span></p>
      <p>Go WASM: <span class="status offline">Offline</span></p>
      <p>Overall: <span class="status offline">Unknown</span></p>
    </div>
  </div>
  
  <div class="section">
    <h2>Mutation Workflow</h2>
    <button id="proposeBtn" disabled>Propose Mutation</button>
    <button id="voteBtn" disabled>Vote YES</button>
    <button id="executeBtn" disabled>Execute Mutation</button>
    <div id="mutationStatus"></div>
  </div>
  
  <div class="section">
    <h2>Organism State</h2>
    <div id="stateDisplay">
      <p>Population: <span id="population">-</span></p>
      <p>Energy: <span id="energy">-</span></p>
      <p>Mutation Rate: <span id="mutationRate">-</span></p>
      <p>Generation: <span id="generation">-</span></p>
      <p>Blockchain Generation: <span id="blockchainGeneration">-</span></p>
    </div>
  </div>
  
  <div class="section">
    <h2>Console Output</h2>
    <button id="clearBtn">Clear Output</button>
    <div id="output"></div>
  </div>
  
  <script type="module">
    import { ChimeraOrchestrator } from './chimera-orchestrator.js';
    
    let orchestrator = null;
    let currentProposalId = null;
    
    const output = document.getElementById('output');
    const initBtn = document.getElementById('initBtn');
    const checkHealthBtn = document.getElementById('checkHealthBtn');
    const proposeBtn = document.getElementById('proposeBtn');
    const voteBtn = document.getElementById('voteBtn');
    const executeBtn = document.getElementById('executeBtn');
    const clearBtn = document.getElementById('clearBtn');
    
    // Console override
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const line = `[${timestamp}] ${message}\n`;
      
      const span = document.createElement('span');
      span.className = type;
      span.textContent = line;
      output.appendChild(span);
      output.scrollTop = output.scrollHeight;
      
      // Also log to real console
      if (type === 'error') {
        originalError(message);
      } else if (type === 'warning') {
        originalWarn(message);
      } else {
        originalLog(message);
      }
    }
    
    console.log = (...args) => log(args.join(' '), 'info');
    console.error = (...args) => log(args.join(' '), 'error');
    console.warn = (...args) => log(args.join(' '), 'warning');
    
    // Update state display
    function updateStateDisplay() {
      if (!orchestrator) return;
      
      const state = orchestrator.getCurrentState();
      document.getElementById('population').textContent = state.population;
      document.getElementById('energy').textContent = state.energy;
      document.getElementById('mutationRate').textContent = state.mutationRate.toFixed(3);
      document.getElementById('generation').textContent = state.generation;
      document.getElementById('blockchainGeneration').textContent = state.blockchainGeneration;
    }
    
    // Update service status display
    function updateServiceStatus() {
      if (!orchestrator) return;
      
      const status = orchestrator.getDetailedServiceStatus();
      
      const statusHTML = `
        <p>Blockchain: <span class="status ${status.blockchain.status}">${status.blockchain.status}</span></p>
        <p>Quantum: <span class="status ${status.quantum.status}">${status.quantum.status}</span></p>
        <p>Bio Sensor: <span class="status ${status.bioSensor.status}">${status.bioSensor.status}</span></p>
        <p>Go WASM: <span class="status ${status.goWasm.status}">${status.goWasm.status}</span></p>
        <p>Overall: <span class="status ${status.overall}">${status.overall}</span></p>
      `;
      
      document.getElementById('serviceStatus').innerHTML = statusHTML;
    }
    
    // Initialize
    initBtn.addEventListener('click', async () => {
      try {
        initBtn.disabled = true;
        log('Initializing ChimeraOrchestrator...', 'info');
        
        orchestrator = new ChimeraOrchestrator({
          enableBlockchain: false, // Mock mode for browser testing
          enableQuantum: true,
          enableBioSensor: true,
          useMockQuantum: true,
          useMockBioSensor: true
        });
        
        // Set up event listeners
        orchestrator.on('serviceHealthChanged', (health) => {
          log('Service health changed', 'info');
          updateServiceStatus();
        });
        
        orchestrator.on('mutationComplete', (event) => {
          log(`Mutation complete! Generation: ${event.generation}`, 'success');
          updateStateDisplay();
        });
        
        await orchestrator.init();
        
        log('Orchestrator initialized successfully!', 'success');
        document.getElementById('initStatus').innerHTML = '<span class="success">âœ“ Initialized</span>';
        
        checkHealthBtn.disabled = false;
        proposeBtn.disabled = false;
        
        updateStateDisplay();
        updateServiceStatus();
        
      } catch (error) {
        log(`Initialization failed: ${error.message}`, 'error');
        initBtn.disabled = false;
      }
    });
    
    // Check health
    checkHealthBtn.addEventListener('click', async () => {
      try {
        log('Checking service health...', 'info');
        await orchestrator.checkServiceHealth();
        updateServiceStatus();
        log('Health check complete', 'success');
      } catch (error) {
        log(`Health check failed: ${error.message}`, 'error');
      }
    });
    
    // Propose mutation
    proposeBtn.addEventListener('click', async () => {
      try {
        proposeBtn.disabled = true;
        log('Proposing mutation...', 'info');
        
        const code = 'IF population > 100 THEN mutation_rate := 0.05 ELSE mutation_rate := 0.1 END';
        currentProposalId = await orchestrator.proposeMutation(code, 'algol');
        
        log(`Proposal created! ID: ${currentProposalId}`, 'success');
        document.getElementById('mutationStatus').innerHTML = 
          `<span class="success">Proposal ID: ${currentProposalId}</span>`;
        
        voteBtn.disabled = false;
        
      } catch (error) {
        log(`Proposal failed: ${error.message}`, 'error');
        proposeBtn.disabled = false;
      }
    });
    
    // Vote
    voteBtn.addEventListener('click', async () => {
      try {
        voteBtn.disabled = true;
        log(`Voting YES on proposal ${currentProposalId}...`, 'info');
        
        await orchestrator.vote(currentProposalId, true);
        
        log('Vote recorded!', 'success');
        executeBtn.disabled = false;
        
      } catch (error) {
        log(`Vote failed: ${error.message}`, 'error');
        voteBtn.disabled = false;
      }
    });
    
    // Execute
    executeBtn.addEventListener('click', async () => {
      try {
        executeBtn.disabled = true;
        log(`Executing mutation ${currentProposalId}...`, 'info');
        
        const result = await orchestrator.executeMutation(currentProposalId);
        
        log('Mutation executed successfully!', 'success');
        log(`New state: Population=${result.newState.population}, Energy=${result.newState.energy}`, 'info');
        
        updateStateDisplay();
        
        // Reset for next mutation
        currentProposalId = null;
        proposeBtn.disabled = false;
        voteBtn.disabled = true;
        executeBtn.disabled = true;
        
      } catch (error) {
        log(`Execution failed: ${error.message}`, 'error');
        executeBtn.disabled = false;
      }
    });
    
    // Clear output
    clearBtn.addEventListener('click', () => {
      output.innerHTML = '';
      log('Output cleared', 'info');
    });
    
    // Initial log
    log('ChimeraOrchestrator Test Interface Ready', 'success');
    log('Click "Initialize Orchestrator" to begin', 'info');
  </script>
</body>
</html>
